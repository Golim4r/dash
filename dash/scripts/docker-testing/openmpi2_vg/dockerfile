# Dockerfile for the DASH project
# This container is based on the openmpi2 container
# and pre configured for valgrind tests
# do NOT use this container for anything else

FROM          dashproject/ci:openmpi2

MAINTAINER    The DASH Team <team@dash-project.org>

RUN           apt-get update -y
RUN           apt-get install libc6-dbg

# Build valgrind from source
WORKDIR       /tmp
ADD           http://valgrind.org/downloads/valgrind-3.12.0.tar.bz2 vg.tar.bz2
RUN           tar -xf vg.tar.bz2
RUN           cd valgrind-3*                        \
              && ./configure --prefix=/opt/valgrind \
              && make                               \
              && make install

# Prepare env
ENV           VALGRIND_BASE=/opt/valgrind
ENV           PATH=${PATH}:${VALGRIND_BASE}/bin
ENV           EXEC_PREFIX="LD_PRELOAD=${VALGRIND_BASE}/lib/valgrind/libmpiwrap-amd64-linux.so"
ENV           EXEC_WRAP="valgrind --track-origins=yes --leak-check=full"

# Set workdir to dash home
WORKDIR       /opt/dash
